"""
ë„ì›€ë§ ëª…ë ¹ì–´ ëª¨ë“ˆ
================
/ë„ì›€ ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
"""

import discord
from datetime import datetime
from .utils import get_bot_footer, send_error_to_error_channel, KST

def setup_help_command(client):
    """ë„ì›€ë§ ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ë¥¼ ë“±ë¡í•˜ëŠ” í•¨ìˆ˜"""
    
    @client.tree.command(name="ë„ì›€", description="ê·¼ìœ¡ëª¬ ë´‡ì˜ ì‚¬ìš©ë²•ì„ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤")
    async def help_slash_command(interaction: discord.Interaction):
        """ë„ì›€ë§ì„ ë³´ì—¬ì£¼ëŠ” ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ (ephemeral)"""
        try:
            # ì¦‰ì‹œ deferí•˜ì—¬ ì‘ë‹µ ì‹œê°„ í™•ë³´
            await interaction.response.defer(ephemeral=True)
            
            print(f"ğŸ’¡ {interaction.user.display_name}ì´(ê°€) /ë„ì›€ ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤.")
            
            # í˜„ì¬ ì‹œê°„ ê³„ì‚°
            now = datetime.now(KST)
            
            # ë„ì›€ë§ ì„ë² ë“œ ìƒì„±
            help_embed = discord.Embed(
                title="ğŸ¦• ê·¼ìœ¡ëª¬ ë´‡ ì‚¬ìš©ë²•",
                description="ìš´ë™ ê¸°ë¡ ê´€ë¦¬ë¥¼ ë„ì™€ì£¼ëŠ” Discord ë´‡ì…ë‹ˆë‹¤!",
                color=0x00ff80,
                timestamp=now
            )
            
            # ê¸°ë³¸ ëª…ë ¹ì–´ ì¶”ê°€
            help_embed.add_field(
                name="ğŸ“ ê¸°ë³¸ ëª…ë ¹ì–´",
                value="""
                `!ìš”ì•½` - ë©¤ë²„ë³„ ìš´ë™ ìš”ì•½ ì •ë³´
                `!í†µê³„` - ì›”ë³„/ì£¼ê°„ ìš´ë™ í†µê³„ 
                `!ì¶”ì„¸` - ìš´ë™ ì¶”ì„¸ ë¶„ì„
                `!ë™ê¸°í™” [ì¼ìˆ˜]` - ìš´ë™ ìŠ¤ë ˆë“œ ì‚¬ì§„ ì—…ë¡œë“œ í˜„í™© ë¶„ì„ (ê¸°ë³¸: 7ì¼, ìµœëŒ€: 30ì¼)
                `/ë„ì›€` - ì´ ë„ì›€ë§ (ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´)
                """.strip(),
                inline=False
            )
            
            # ìš”ì•½ ëª…ë ¹ì–´ ìƒì„¸ ì„¤ëª…
            help_embed.add_field(
                name="ğŸ“Š !ìš”ì•½",
                value="""
                **ê¸°ëŠ¥**: ë©¤ë²„ë³„ ìš´ë™ ìš”ì•½ ì •ë³´
                **ì‚¬ìš©ë²•**: `!ìš”ì•½`
                **ì œê³µ ì •ë³´**:
                â€¢ ëˆ„ì  ìš´ë™ ì¼ìˆ˜ ë° ìš´ë™ìœ¨
                â€¢ í˜„ì¬ ì—°ì† ìš´ë™ ê¸°ë¡
                â€¢ ìµœì¥ ì—°ì† ìš´ë™ ê¸°ë¡
                â€¢ ì´ë²ˆ ì£¼ ìš´ë™ ì§„í–‰ë¥ 
                """.strip(),
                inline=False
            )
            
            # í†µê³„ ëª…ë ¹ì–´ ìƒì„¸ ì„¤ëª…
            help_embed.add_field(
                name="ğŸ“ˆ !í†µê³„",
                value="""
                **ê¸°ëŠ¥**: ì›”ë³„/ì£¼ê°„ ìš´ë™ í†µê³„
                **ì‚¬ìš©ë²•**: `!í†µê³„`
                **ì œê³µ ì •ë³´**:
                â€¢ ì›”ë³„ í†µê³„ (ìµœê·¼ 3ê°œì›”)
                â€¢ ì£¼ê°„ í†µê³„ (ì§€ë‚œì£¼ë¶€í„° 4ì£¼)
                â€¢ í‰ê·  ìš´ë™ì¼ ë° ìš´ë™ìœ¨
                """.strip(),
                inline=False
            )
            
            # ì¶”ì„¸ ëª…ë ¹ì–´ ìƒì„¸ ì„¤ëª…
            help_embed.add_field(
                name="ğŸ“Š !ì¶”ì„¸",
                value="""
                **ê¸°ëŠ¥**: ìš´ë™ ì¶”ì„¸ ë¶„ì„
                **ì‚¬ìš©ë²•**: `!ì¶”ì„¸`
                **ì œê³µ ì •ë³´**:
                â€¢ ì§€ë‚œì£¼ë¶€í„° 4ì£¼ê°„ ì¶”ì„¸ ë¶„ì„
                â€¢ ê°œì¸ë³„ ìš´ë™ìœ¨ ë³€í™” ì¶”ì„¸
                â€¢ ì „ì²´ ê·¸ë£¹ í‰ê·  ì¶”ì„¸
                """.strip(),
                inline=False
            )
            
            # ë™ê¸°í™” ëª…ë ¹ì–´ ìƒì„¸ ì„¤ëª…
            help_embed.add_field(
                name="ğŸ”„ !ë™ê¸°í™”",
                value="""
                **ê¸°ëŠ¥**: ìš´ë™ ìŠ¤ë ˆë“œ ì‚¬ì§„ ì—…ë¡œë“œ í˜„í™© ë¶„ì„
                **ì‚¬ìš©ë²•**: `!ë™ê¸°í™”` ë˜ëŠ” `!ë™ê¸°í™” [ì¼ìˆ˜]`
                **ì œê³µ ì •ë³´**:
                â€¢ ì¼ë³„ ìš´ë™ ìŠ¤ë ˆë“œì—ì„œ ì‚¬ìš©ìë³„ ì‚¬ì§„ ì—…ë¡œë“œ í˜„í™© (ê¸°ë³¸: 7ì¼, ìµœëŒ€: 30ì¼)
                â€¢ ì‚¬ìš©ìë³„ ì´ ì—…ë¡œë“œ ì¼ìˆ˜ ë­í‚¹
                â€¢ ì¼ë³„ ì—…ë¡œë“œ ì°¸ì—¬ì ìˆ˜ í˜„í™©
                """.strip(),
                inline=False
            )
            
            # ìë™í™” ê¸°ëŠ¥ ì„¤ëª…
            help_embed.add_field(
                name="ğŸ¤– ìë™í™” ê¸°ëŠ¥",
                value="""
                **ì¼ê°„ ìš´ë™ ì§‘ê³„**: ë§¤ì¼ 23:50 ìë™ ì‹¤í–‰
                **ì£¼ê°„ í†µê³„ ì§‘ê³„**: ë§¤ì£¼ ì›”ìš”ì¼ 09:00 ìë™ ì‹¤í–‰
                **ì§€ì†ì ì¸ ëª¨ë‹ˆí„°ë§**: 24ì‹œê°„ ìš´ë™ ë°ì´í„° ì¶”ì 
                """.strip(),
                inline=False
            )
            
            # ê¸°ëŠ¥ ì•ˆë‚´
            help_embed.add_field(
                name="âœ¨ ì£¼ìš” íŠ¹ì§•",
                value="""
                â€¢ **ì‹¤ì‹œê°„ ìš´ë™ ì¶”ì **: ë§¤ì¼ ìë™ìœ¼ë¡œ ìš´ë™ ë°ì´í„° ìˆ˜ì§‘
                â€¢ **ìƒì„¸í•œ í†µê³„**: ê°œì¸ë³„/ê·¸ë£¹ë³„ ë‹¤ì–‘í•œ í†µê³„ ì œê³µ
                â€¢ **ì¶”ì„¸ ë¶„ì„**: ìš´ë™ íŒ¨í„´ ë³€í™” ë¶„ì„
                â€¢ **ì‚¬ìš©ì ì¹œí™”ì **: ì§ê´€ì ì¸ ëª…ë ¹ì–´ì™€ ì‹œê°ì  í‘œí˜„
                ì˜ˆì‹œ: `!ìš”ì•½`, `!í†µê³„`, `!ì¶”ì„¸`, `/ë„ì›€`
                """.strip(),
                inline=False
            )
            
            # í‘¸í„° ì„¤ì •
            help_embed.set_footer(text=get_bot_footer())
            
            # ephemeralë¡œ ì‘ë‹µ (ë³¸ì¸ë§Œ ë³¼ ìˆ˜ ìˆìŒ)
            await interaction.followup.send(embed=help_embed, ephemeral=True)
            print(f"âœ… /ë„ì›€ ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ ì‹¤í–‰ ì™„ë£Œ: ephemeral ë„ì›€ë§ ì „ì†¡")
            
        except Exception as e:
            print(f"âŒ /ë„ì›€ ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {e}")
            await send_error_to_error_channel(
                client, 
                f"ë„ì›€ë§ ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {str(e)}", 
                type(e).__name__, 
                "/ë„ì›€ ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´",
                f"{interaction.user.display_name} (ID: {interaction.user.id})"
            )
            
            try:
                # ì˜¤ë¥˜ ë°œìƒ ì‹œ ê°„ë‹¨í•œ ë©”ì‹œì§€ë§Œ ì „ì†¡
                if not interaction.response.is_done():
                    await interaction.response.send_message("â³ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...", ephemeral=True)
                else:
                    await interaction.followup.send("â³ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...", ephemeral=True)
            except Exception as followup_error:
                print(f"âŒ /ë„ì›€ ì—ëŸ¬ ì‘ë‹µ ì „ì†¡ ì‹¤íŒ¨: {followup_error}")
    
    print("âœ… ë„ì›€ë§ ëª…ë ¹ì–´ ë“±ë¡ ì™„ë£Œ")
